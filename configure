#!/usr/bin/env python2
# coding: utf8

SOURCE_DIR = 'src'

import os
import re
import commands

makefile = open("Makefile", "w");
makefile.write("include Makefile.header\n\n")

cfiles = []
hfiles = []
asmfiles = []

for root, dirs, files in os.walk(SOURCE_DIR, True, None, True):
	if ".git" in root or "tools" in root:
		continue
	
	for f in files:
		path = (root + "/" + f)

		if path.endswith(".c"):
			cfiles.append(path)

		elif path.endswith(".h"):
			hfiles.append(path)

		elif path.endswith(".asm"):
			asmfiles.append(path)

makefile.write("xelix.bin:")
for f in asmfiles:
	makefile.write(" " + f[:-4] + "-asm.o")
	
for f in cfiles:
	makefile.write(" " + f[:-2] + ".o")

makefile.write("""
	ld -melf_i386 -Ttext=0x100000 -nostdlib -o xelix.bin $^
	chmod -x xelix.bin
""")

for f in hfiles + cfiles:
	deps = commands.getoutput("gcc -nostdinc -I src -MM {0} -MQ {0}".format(f))
	deps = ''.join(deps.split('\\\n '))
	deps = deps.split(' ')
	deps = deps[0] + ' ' + ' '.join(deps[2:])

	makefile.write('{0}\n'.format(deps))

makefile.write("\n# clean\n");
makefile.write(".PHONY: clean\n");
makefile.write("clean:\n\trm -rf xelix.bin mount floppy.img buildinfo.h ")
for f in asmfiles:
	makefile.write(" " + f[:-4] + "-asm.o")
for f in cfiles:
	makefile.write(" " + f[:-2] + ".o")

makefile.write("\n\n")
makefile.write("include Makefile.footer")
makefile.close()
