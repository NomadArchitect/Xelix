#!/usr/bin/env bash

# configure: Makefile generator
# Copyright Â© 2011-2019 Lukas Martini

# This file is part of Xelix.
#
# Xelix is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# Xelix is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Xelix. If not, see <http://www.gnu.org/licenses/>.

function w {
	echo "$@" >> Makefile
}

FIND=$(command -v gfind || command -v find)

# Update submodules
git submodule update --init 1> /dev/null

# Get files
arch=`sed -rn 's/\#define ARCH "([^"]+)"/\1/p' src/lib/config.h`
extensions="\.\(c\|asm\|s\|psf\)"
arch_files=`$FIND -L src -type f -iregex "^.*$arch-.*$extensions" | tr '\n' '  '`
files=`$FIND -L src -type f -iregex "^[^\-]*$extensions" | tr '\n' '  '`
files="$arch_files$files"

echo -e "# This file has been generated by ./configure. You usually don't \
want to change it manually.\n" > Makefile

if [ "$arch" == "arm" ]; then
	prefix="arm-none-eabi"
	w "ARCH_CFLAGS := -mcpu=arm1176jzf-s -fpic"
	w "MAKE_ASFLAGS := \$(ARCH_CFLAGS) -ffreestanding"
	w "AS := $prefix-gcc"
else
	prefix="i786-pc-xelix"
	w "ARCH_CFLAGS := -mtune=sandybridge -mgeneral-regs-only -mhard-float"
	w "MAKE_ASFLAGS := -g -f elf"
	w "AS := nasm"
fi

w "CC := $prefix-gcc"
w "OBJCOPY := $prefix-objcopy"
w "QEMU := qemu-system-$arch"
w "include Makefile.static"

w -n "xelix.bin: "
for i in $files
do
	w -n " ${i%\.*}"

	if [[ ${i##*.} =~ ^(asm|S|psf)$ ]]; then
		w -n "-${i##*.}"
	fi
	w -n ".o"
done

w " ext/picotcp/build/lib/libpicotcp.a"
w "	\$(LD) $^ -o xelix.bin \$(MAKE_LDFLAGS) \$(LDFLAGS)"

for i in $files
do
	deps=`gcc -nostdinc -I src -MM $i -MQ $i 2> /dev/null | tr ' \n ' ' ' | tr ' \\\  ' ' '`
	deps=($deps)
	unset deps[1]
	deps[0]=$(echo "${deps[0]}" | sed 's/\.c/\.o/')
	w ${deps[*]}
done
